<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@mediapipe/holistic/holistic.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./styles.css" />
  </head>

  <body>
    <div class="container">
      <div>
        <video class="input_video"></video>
      </div>
      <div class="output_video">
        <div class="images">
          <div id="1"></div>
          <img id="2" class="isWearing" src="./img/sunglasses.png" />
          <div id="3"></div>
          <img id="4" src="./img/sunglasses2.png" />
          <div id="5"></div>
          <img id="6" src="./img/sunglasses3.png" />
          <div id="7"></div>
        </div>
        <canvas class="output_canvas" width="1280px" height="720px"></canvas>
      </div>
    </div>
  </body>
</html>

<script type="module">
  const videoElement = document.getElementsByClassName("input_video")[0];
  const canvasElement = document.getElementsByClassName("output_canvas")[0];
  const sunglass = document.getElementById("1");
  const canvasCtx = canvasElement.getContext("2d");

  function onResults(results) {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    canvasCtx.drawImage(
      results.image,
      0,
      0,
      canvasElement.width,
      canvasElement.height
    );

    let index_finger = null;
    let point = null;
    let stopSwitch = false;

    if (results.faceLandmarks) {
      let width = canvasElement.width;
      let height = canvasElement.height;

      let beginX = results.faceLandmarks[156].x * canvasElement.width;
      let endX = results.faceLandmarks[383].x * canvasElement.width;

      let beginY = results.faceLandmarks[9].y * canvasElement.height;
      let endY = results.faceLandmarks[5].y * canvasElement.height;

      if (results.rightHandLandmarks) {
        index_finger = results.rightHandLandmarks[8];
        point = Math.floor((index_finger.y * canvasElement.height) / 102.8);
      } else if (results.leftHandLandmarks) {
        index_finger = results.leftHandLandmarks[8];
        point = Math.floor((index_finger.y * canvasElement.height) / 102.8);
      }

      const switchGlasses = () => {
        if (document.getElementById(point).className != "isWearing") {
          if (document.querySelector(".isWearing") != null) {
            document.querySelector(".isWearing").classList.remove("isWearing");
          }
          document.getElementById(point).classList.add("isWearing");
        } else {
          document.querySelector(".isWearing").classList.remove("isWearing");
        }
      };

      const containsGlasses = [2, 4, 6];
      if (index_finger != null && point != null) {
        if (
          index_finger.x * canvasElement.width > 1030 &&
          stopSwitch === false &&
          containsGlasses.includes(point)
        ) {
          switchGlasses(point);
          stopSwitch = true;
        } else if (index_finger.x * canvasElement.width < 1030) {
          stopSwitch = false;
        }
      }

      // canvasCtx.fillStyle = `rgba(255, 221,0, 0.5)`;
      let isWearing = document.querySelector(".isWearing");
      if (isWearing != null) {
        canvasCtx.drawImage(
          isWearing,
          beginX,
          beginY,
          endX - beginX,
          endY - beginY
        );
      }
    }

    /*
                canvasCtx.drawImage(results.segmentationMask, 0, 0,
                    canvasElement.width, canvasElement.height);

                // Only overwrite existing pixels.
                // canvasCtx.globalCompositeOperation = 'source-in';
                // canvasCtx.fillStyle = '#00FF00';
                // canvasCtx.fillRect(0, 0, canvasElement.width, canvasElement.height);

                // Only overwrite missing pixels.
                // canvasCtx.globalCompositeOperation = 'destination-atop';


                canvasCtx.globalCompositeOperation = 'source-over';
                // drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS,
                //     { color: '#00FF00', lineWidth: 4 });
                // drawLandmarks(canvasCtx, results.poseLandmarks,
                //     { color: '#FF0000', lineWidth: 2 });
                // drawConnectors(canvasCtx, results.faceLandmarks, FACEMESH_TESSELATION,
                //     { color: '#C0C0C070', lineWidth: 1 });
                // drawConnectors(canvasCtx, results.leftHandLandmarks, HAND_CONNECTIONS,
                //     { color: '#CC0000', lineWidth: 5 });
                // drawLandmarks(canvasCtx, results.leftHandLandmarks,
                //     { color: '#00FF00', lineWidth: 2 });
                // drawConnectors(canvasCtx, results.rightHandLandmarks, HAND_CONNECTIONS,
                //     { color: '#00CC00', lineWidth: 5 });
                // drawLandmarks(canvasCtx, results.rightHandLandmarks,
                //     { color: '#FF0000', lineWidth: 2 });*/
    canvasCtx.restore();
  }

  const holistic = new Holistic({
    locateFile: (file) => {
      return `https://cdn.jsdelivr.net/npm/@mediapipe/holistic/${file}`;
    },
  });
  holistic.setOptions({
    modelComplexity: 1,
    smoothLandmarks: true,
    enableSegmentation: true,
    smoothSegmentation: true,
    refineFaceLandmarks: true,
    minDetectionConfidence: 0.5,
    minTrackingConfidence: 0.5,
  });
  holistic.onResults(onResults);

  const camera = new Camera(videoElement, {
    onFrame: async () => {
      await holistic.send({ image: videoElement });
    },
    width: 1280,
    height: 720,
  });
  camera.start();
</script>
